# This is a workflow to compile the cdeps source without cime
name: extbuild
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build-cdeps:
    runs-on: ubuntu-latest
    env:
      CC: mpicc
      FC: mpifort
      CXX: mpicxx
      CPPFLAGS: "-I/usr/include -I/usr/local/include "
      # Versions of all dependencies can be updated here - these match tag names in the github repo
      ESMF_VERSION: v8.4.0
      PNETCDF_VERSION: checkpoint.1.12.3
      NETCDF_FORTRAN_VERSION: v4.6.0
      ParallelIO_VERSION: pio2_5_10
    steps:
      - id: checkout-CDEPS
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - id: load-env
        run: |
          sudo apt-get update
          sudo apt-get install gfortran wget openmpi-bin netcdf-bin libopenmpi-dev libnetcdf-dev autotools-dev autoconf
      - id: cache-pnetcdf
        uses: actions/cache@v3
        with:
          path: ~/pnetcdf
          key: ${{ runner.os }}-${{ env.PNETCDF_VERSION}}-pnetcdf
      - name: Build PNetCDF
        if: steps.cache-pnetcdf.outputs.cache-hit != 'true'
        uses: NCAR/ParallelIO/.github/actions/buildpnetcdf
        with:
          pnetcdf_version: ${{ env.PNETCDF_VERSION }}
          install_prefix: $HOME/pnetcdf
      - name: Cache netcdf-fortran
        id: cache-netcdf-fortran
        uses: actions/cache@v3
        with:
          path: ~/netcdf-fortran
          key: ${{ runner.os }}-${{ env.NETCDF_FORTRAN_VERSION }}-netcdf-fortran
      - name: Build NetCDF Fortran
        if: steps.cache-netcdf-fortran.outputs.cache-hit != 'true'
        uses: NCAR/ParallelIO/.github/actions/buildnetcdff
        with:
          netcdf_fortran_version: ${{ env.NETCDF_FORTRAN_VERSION }}
          install_prefix: $HOME/netcdf-fortran
          netcdf_c_path: /usr
      - name: Cache PARALLELIO
        id: cache-PARALLELIO
        uses: actions/cache@v3
        with:
          path: ~/pio
          key: ${{ runner.os }}-${{ env.ParallelIO_VERSION }}-parallelio
      - name: Build ParallelIO
        if: steps.cache-PARALLELIO.outputs.cache-hit != 'true'
        uses: NCAR/ParallelIO/.github/actions/parallelio_cmake
        with:
          parallelio_version: ${{ env.ParallelIO_VERSION }}
          netcdf_c_path: /usr
          netcdf_fortran_path: $HOME/netcdf-fortran
          pnetcdf_path: $HOME/pnetcdf
          install_prefix: $HOME/pio
      - id: cache-esmf
        uses: actions/cache@v3
        with:
          path: ~/ESMF
          key: ${{ runner.os }}-${{ env.ESMF_VERSION }}-ESMF1
      - name: Build ESMF
        if: steps.cache-esmf.outputs.cache-hit != 'true'
        uses: ./.github/actions/buildesmf
        with:
          esmf_version: ${{ env.ESMF_VERSION }}
          esmf_bopt: g
          esmf_comm: openmpi
          install_prefix: $HOME/ESMF
          netcdf_c_path: /usr
          netcdf_fortran_path: $HOME/netcdf-fortran
          pnetcdf_path: $HOME/pnetcdf
          parallelio_path: $HOME/pio
      - name: Build CDEPS
        run: |
          export ESMFMKFILE=$HOME/ESMF/lib/libg/Linux.gfortran.64.openmpi.default/esmf.mk
          export PIO=$HOME/pio
          export SRC_ROOT=
          mkdir build-cdeps
          pushd build-cdeps
          cmake -Wno-dev -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_Fortran_FLAGS="-DCPRGNU -g -Wall -ffree-form -ffree-line-length-none -fallow-argument-mismatch " ../
          make VERBOSE=1
          popd
